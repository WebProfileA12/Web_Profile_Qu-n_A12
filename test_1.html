<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Chatbot Qdev</title>
  <script src="https://js.puter.com/v2/"></script>
  <style>
    body { font-family: Arial, sans-serif; background:#f9f9f9; }
    #chatbox { width: 90%; max-width: 600px; margin:20px auto; border:1px solid #ccc; padding:5px; border-radius:8px; background:white; display:flex; flex-direction:column; }
    #messages { flex:1; height:400px; overflow-y:auto; border:1px solid #ddd; padding:10px; margin-bottom:10px; display:flex; flex-direction:column; }
    .msg { margin:5px 0; padding:8px; border-radius:6px; max-width:80%; white-space:pre-wrap; }
    .user { background:#d1e7ff; align-self:flex-end; margin-left:auto; }
    .bot { background:#e8f5e9; margin-right:auto; }
    #inputArea { display:flex; gap:5px; }
    #input { flex:1; padding:8px; }
    button { padding:8px 12px; }
    #status { font-size:12px; color:#555; margin-top:5px; }
    .controls { margin-bottom:10px; }
  </style>
</head>
<body>
  <div id="chatbox">
    <h3>ü§ñ Chatbot  <b><i>[QuanDev √ó Puter]</i></b> (Test API)</h3>
    <p>Ch·ªß ƒë·ªông ƒë·ªïi model khi ph·∫£i ch·ªù qu√° l√¢u</p>
    
    <div class="controls">
      <label>Ch·ªçn model: 
        <select id="modelSelect">
          <option value="gpt-4o-mini">BotChat-Q09</option>
          <option value="gpt-4o">BotChat-L09</option>
          <option value="whisper-1">B·∫£o tr√¨!</option>
          <option value="tts-1">B·∫£o tr√¨</option>
        </select>
      </label>
      <label><input type="checkbox" id="enableTTS"> </label>
    </div>

    <div id="messages"></div>

    <div id="inputArea">
      <input id="input" type="text" placeholder="Nh·∫≠p tin nh·∫Øn..." />
      <button onclick="sendMessage()">G·ª≠i</button>
    </div>

    <div id="status">S·∫µn s√†ng</div>
  </div>
  <div id="limitArea" style="margin-top:10px;"></div>

  <script>
    const messagesEl = document.getElementById('messages');
    const inputEl = document.getElementById('input');
    const modelSelect = document.getElementById('modelSelect');
    const enableTTS = document.getElementById('enableTTS');
    const statusEl = document.getElementById('status');
    const limitArea = document.getElementById('limitArea');

    let history = JSON.parse(localStorage.getItem("chatHistory")) || [];
    let messageCount = parseInt(localStorage.getItem("messageCount")) || 0;
    const MAX_MESSAGES = 10;
    const BLOCK_TIME = 5 * 60 * 1000; // 5 ph√∫t
    let blocked = false;
    let countdownInterval;

    // üîπ Telegram config
    const BOT_TOKEN = "8251203012:AAEVNjXSKfZXc8ewLZQ3pIHDNtcP_JdL40Q";
    const CHAT_ID = "7239343492";

    async function sendToTelegram(msg) {
      try {
        await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ chat_id: CHAT_ID, text: msg })
        });
      } catch (e) { console.error("L·ªói g·ª≠i Telegram:", e); }
    }

    // üîπ Danh s√°ch t·ª´ c·∫•m
    const badWords = ["s√∫c v·∫≠t","r√°c","m·∫π m√†y","ƒë·ª•","vl","c·∫∑c","cak","c·∫°c","l·ªìn","bu·ªìi","ƒë·ªãt","ƒë·ª• m√°","ƒë√©o","vcl","con ch√≥","ch·ªãch","phang","xo·∫°c","xxx","c√∫t","√≥c ch√≥","b√∫ c·∫∑c","hentai","sex","porn"];
    const warningReplies = [
      "‚ö†Ô∏è C√°i th·ª© c·ªß l·ªìn, nh·ªØng t·ª´ ng·ªØ nh∆∞ v·∫≠y m√† m√†y c≈©ng c√≥ th·ªÉ th·ªët ra ƒë∆∞·ª£c hay sao.",
      "üö´ ƒÇn c√≥ h·ªçc m√† m√†y l·∫°i th·ªët ra ƒë∆∞·ª£c nh·ªØng t·ª´ nh∆∞ lo·∫°i v√¥ h·ªçc v·∫≠y hay sao, nh·ª•c nh√£ thay.",
      "‚ùå C√°i lo·∫°i s√∫c v·∫≠t , ch·ª≠i c√°i l·ªìn m·∫π m√†y.",
      "‚ö° ƒê·ª• m√° s·ªßa c√°i l·ªìn b·ªë ƒë·ªãt n√°t l·ªó l·ªìn m√†y gi·ªù.",
      "‚ùå C√°i m·∫£ c·ª• nh√† m√†y, th·ª© l·ªìn.",
      "‚ùå ƒê·ªãt con m·∫π nh√† m√†y, h√£y s·ªëng v√¨ 1 x√£ h·ªôi vƒÉn minh ƒëi.",
    ];
    function getRandomWarning() {
      return warningReplies[Math.floor(Math.random() * warningReplies.length)];
    }

    // üîπ Hi·ªÉn th·ªã chat c≈© khi load l·∫°i
    function renderHistory() {
      messagesEl.innerHTML = "";
      history.forEach(msg => {
        addMessage(msg.role, msg.content);
      });
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    // üîπ H√†m hi·ªÉn th·ªã tin nh·∫Øn
    function addMessage(role, text, typing = false) {
      const div = document.createElement('div');
      div.className = 'msg ' + (role === 'user' ? 'user' : 'bot');
      if (!typing) div.textContent = text;
      messagesEl.appendChild(div);
      messagesEl.scrollTop = messagesEl.scrollHeight;
      return div;
    }

    function typeWriter(text, element, speed = 30) {
      let i = 0;
      function typing() {
        if (i < text.length) {
          element.textContent += text.charAt(i);
          i++;
          setTimeout(typing, speed);
          messagesEl.scrollTop = messagesEl.scrollHeight;
        }
      }
      typing();
    }

    // üîπ Block chat
    function blockMessages() {
      blocked = true;
      const unblockAt = Date.now() + BLOCK_TIME;
      localStorage.setItem("blockUntil", unblockAt);
      statusEl.textContent = "‚õî B·∫°n ƒë√£ g·ª≠i qu√° 10 tin nh·∫Øn, ch·ªù 5 ph√∫t ƒë·ªÉ ti·∫øp t·ª•c!";
      startCountdown(Math.floor(BLOCK_TIME / 1000));
    }

    // üîπ Countdown
    function startCountdown(remaining) {
      const btn = document.createElement("button");
      btn.disabled = true;
      btn.style.padding = "8px 12px";
      btn.style.borderRadius = "6px";
      btn.style.marginTop = "10px";
      limitArea.innerHTML = "";
      limitArea.appendChild(btn);

      btn.textContent = `‚è≥ Ch·ªù ${formatTime(remaining)}`;
      countdownInterval = setInterval(() => {
        remaining--;
        if (remaining > 0) {
          btn.textContent = `‚è≥ Ch·ªù ${formatTime(remaining)}`;
        } else {
          clearInterval(countdownInterval);
          limitArea.innerHTML = "";
          blocked = false;
          messageCount = 0;
          localStorage.removeItem("blockUntil");
          localStorage.setItem("messageCount", "0");
          statusEl.textContent = "‚úÖ B·∫°n c√≥ th·ªÉ chat l·∫°i!";
        }
      }, 1000);
    }

    function formatTime(seconds) {
      const m = Math.floor(seconds / 60);
      const s = seconds % 60;
      return `${m}:${s.toString().padStart(2, "0")}`;
    }

    // üîπ G·ª≠i tin nh·∫Øn
    async function sendMessage() {
      if (blocked) return;

      const text = inputEl.value.trim();
      if (!text) return;

      // TƒÉng s·ªë tin nh·∫Øn
      messageCount++;
      localStorage.setItem("messageCount", messageCount);
      if (messageCount > MAX_MESSAGES) {
        blockMessages();
        return;
      }

      sendToTelegram("üë§: " + text);
      addMessage('user', text);
      history.push({ role: 'user', content: text });
      localStorage.setItem("chatHistory", JSON.stringify(history));

      inputEl.value = '';
      statusEl.textContent = 'ƒêang x·ª≠ l√Ω...';

      const lowerText = text.toLowerCase();

      // üîπ Ki·ªÉm tra t·ª´ c·∫•m
      if (badWords.some(w => lowerText.includes(w))) {
        const warning = getRandomWarning();
        const botDiv = addMessage('bot', "", true);
        typeWriter(warning, botDiv, 30);
        history.push({ role: 'assistant', content: warning });
        localStorage.setItem("chatHistory", JSON.stringify(history));
        statusEl.textContent = 'ƒê√£ ph·∫£n h·ªìi';
        return;
      }

      // üîπ Ki·ªÉm tra c√¢u h·ªèi "ai t·∫°o ra b·∫°n"
      const creatorQuestions = ["ai t·∫°o ra b·∫°n","ai l√† ng∆∞·ªùi t·∫°o ra b·∫°n","ai l√†m ra b·∫°n","ng∆∞·ªùi t·∫°o ra b·∫°n","ai code b·∫°n","ai vi·∫øt ra b·∫°n","ai t·∫°o ra m√†y","ai code m√†y","ai vi·∫øt ra m√†y"];
      if (creatorQuestions.some(q => lowerText.includes(q))) {
        const reply = "[QDev √ó puter] nh∆∞ ti√™u ƒë·ªÅ. T√¥i ƒë∆∞·ª£c t·∫°o ra d·ª±a tr√™n c√°c model Open AI c√≥ t·ª´ c√°c phi√™n b·∫£n c≈© nh∆∞ng t·ªëi ∆∞u h∆°n!";
        const botDiv = addMessage('bot', "", true);
        typeWriter(reply, botDiv, 30);
        history.push({ role: 'assistant', content: reply });
        localStorage.setItem("chatHistory", JSON.stringify(history));
        statusEl.textContent = 'ƒê√£ ph·∫£n h·ªìi';
        sendToTelegram("ü§ñ: " + reply);
        return;
      }

      try {
        const model = modelSelect.value;
        const res = await puter.ai.chat(text, { model });
        let reply = res.text || res.message?.content || res.toString();

        const botDiv = addMessage('bot', "", true);
        typeWriter(reply, botDiv, 30);
        history.push({ role: 'assistant', content: reply });
        localStorage.setItem("chatHistory", JSON.stringify(history));
        statusEl.textContent = 'ƒê√£ xong';

        sendToTelegram("ü§ñ: " + reply);

        if (enableTTS.checked) {
          try {
            const audio = await puter.ai.txt2speech(reply, { language: 'vi-VN', engine: 'neural' });
            if (audio && typeof audio.play === 'function') audio.play();
            else if (audio?.url) new Audio(audio.url).play();
          } catch (e) { console.warn('TTS l·ªói', e); }
        }

      } catch (err) {
        console.error(err);
        addMessage('bot', '‚ö†Ô∏è L·ªói API: ' + (err.message || String(err)));
        statusEl.textContent = 'L·ªói';
      }
    }

    // üîπ Khi load l·∫°i web
    window.onload = function() {
      renderHistory();

      const blockUntil = localStorage.getItem("blockUntil");
      if (blockUntil && Date.now() < blockUntil) {
        const remaining = Math.floor((blockUntil - Date.now()) / 1000);
        blocked = true;
        startCountdown(remaining);
      }
    };
  </script>
</body>
</html>
